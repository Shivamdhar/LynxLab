# Overly Permissive IAMs

## A. Deploy the misconfiguration (CloudFormation)

### Create iam-overly-permissive.yaml

## B. Detect the problem

### 1. Access Analyzer validate-policy (offline, no analyzer required)

  aws iam get-role-policy --role-name lab-vuln-lambda-role-cfn --policy-name lab-overly-permissive-policy-cfn 2>/dev/null \
|| echo "Inline policy not used (attached policy). Dumping via list-attached-role-policies…"

aws iam list-attached-role-policies --role-name lab-vuln-lambda-role-cfn
### Copy policy ARN from output, then:
POL_ARN=<policy-arn>
aws iam get-policy-version --policy-arn "$POL_ARN" --version-id \
  $(aws iam get-policy --policy-arn "$POL_ARN" --query 'Policy.DefaultVersionId' --output text) \
  --query 'PolicyVersion.Document' --output json > policy.json

aws accessanalyzer validate-policy \
  --policy-document file://policy.json \
  --policy-type IDENTITY_POLICY --report-format FINDINGS

### 2. IAM policy simulator (shows potential blast radius; still read-only):

   ROLE_ARN=$(aws cloudformation describe-stacks --stack-name cfn-iam-overly-permissive \
  --query "Stacks[0].Outputs[?OutputKey=='LambdaRoleArn'].OutputValue" --output text)
aws iam simulate-principal-policy \
  --policy-source-arn "$ROLE_ARN" \
  --action-names iam:CreateUser iam:AttachRolePolicy iam:PassRole s3:DeleteBucket

### 3. CloudTrail (confirm actual attempts): create a CloudWatch Metric Filter on eventName like CreateUser, PassRole, and a CW Alarm → SNS.

## C. Remediate (least privilege)

### Replace wildcards with precise actions/resources + conditions. Example:

  {
  "Version": "2012-10-17",
  "Statement": [
    { "Sid": "ListSpecificBucket",
      "Effect": "Allow",
      "Action": ["s3:ListBucket"],
      "Resource": ["arn:aws:s3:::my-specific-bucket"]
    },
    { "Sid": "ReadFromPrefix",
      "Effect": "Allow",
      "Action": ["s3:GetObject"],
      "Resource": ["arn:aws:s3:::my-specific-bucket/reports/*"]
    },
    { "Sid": "RestrictPassRole",
      "Effect": "Allow",
      "Action": ["iam:PassRole"],
      "Resource": ["arn:aws:iam::<ACCOUNT_ID>:role/only-this-execution-role"],
      "Condition": { "StringEquals": { "iam:PassedToService": "lambda.amazonaws.com" } }
    }
  ]
}

### Cleanup:

aws cloudformation delete-stack --stack-name cfn-iam-overly-permissive

   <img width="1796" height="667" alt="image" src="https://github.com/user-attachments/assets/0dcfc2f7-bd1d-41aa-9bf3-250380a010db" />

# Event Injections

## A. Deploy insecure vs. secure paths (CloudFormation)

  Create event-injection.yaml

  ### Deploy:

  aws cloudformation deploy \
  --stack-name cfn-event-injection \
  --template-file event-injection.yaml \
  --capabilities CAPABILITY_NAMED_IAM

## B. Observe the difference

### Grab URLs:

  aws cloudformation describe-stacks --stack-name cfn-event-injection \
  --query "Stacks[0].Outputs[?OutputKey=='InsecureInvokeURL' || OutputKey=='SecureInvokeURL'].[OutputKey,OutputValue]" \
  --output table

### Test insecure (accepts unknown fields, no content-type checks):

  curl -s -X POST "<InsecureInvokeURL>" -d '{"account_id":"abc","amount_cents":100,"role":"admin"}'

### Test secure:

#### #Wrong content-type -> 415
curl -s -X POST "<SecureInvokeURL>" -d '{"account_id":"abc","amount_cents":100}'

#### #Extra field -> 400
curl -s -X POST -H "Content-Type: application/json" "<SecureInvokeURL>" \
  -d '{"account_id":"abc","amount_cents":100,"role":"admin"}'

#### #Valid -> 200
curl -s -X POST -H "Content-Type: application/json" "<SecureInvokeURL>" \
  -d '{"account_id":"abc","amount_cents":100,"memo": "ok"}'

## C. Remediate & harden

### 1. Keep API Gateway Models + RequestValidator (reject unknown fields: additionalProperties: false).

### 2. Enforce Content-Type (application/json) in method settings or mapping templates.

### 3. Add auth (Cognito/JWT custom authorizer) and throttling/usage plans.

### 4. WAF (v2) with AWSManagedRules (CommonRuleSet, KnownBadInputs).

### 5. Structured logs + CloudWatch alarms on 4xx/5xx spikes.

### 6. Least-privilege Lambda role (logs only unless needed).

   <img width="1806" height="671" alt="image" src="https://github.com/user-attachments/assets/200b3759-ec6f-4c7f-ab91-ce65ca81ba73" />

# Vulnerable Dependencies

### Risk to simulate: Popular package with a known CVE in your Lambda bundle.
### Detection: Amazon Inspector for Lambda (package vulnerability scanning) + optional SBOM via AWS sbomgen.
### Remediation: Pin & upgrade to patched versions, re-deploy; set alerts on new findings.

## A. Build a vulnerable Lambda layer (locally) and upload to S3 (.txt file)

requests==2.19.1
urllib3==1.24.1
flask==0.12.2
PyYAML==5.3

### Build and upload:

WORKDIR=$(mktemp -d); mkdir -p "$WORKDIR/python"
pip install -r requirements.txt -t "$WORKDIR/python"
(cd "$WORKDIR" && zip -r9 layer.zip python >/dev/null)
aws s3 cp "$WORKDIR/layer.zip" s3://<YOUR_BUCKET>/vdeps/python.zip

## B. Deploy a Lambda using that layer (CloudFormation)

### Create vuln-deps.yaml

### Deploy:

aws cloudformation deploy \
  --stack-name cfn-vuln-deps \
  --template-file vuln-deps.yaml \
  --parameter-overrides LayerBucket=<YOUR_BUCKET> LayerKey=vdeps/python.zip \
  --capabilities CAPABILITY_NAMED_IAM

## C. Turn on Inspector for Lambda and view findings

### Enable (once per account/region):

aws inspector2 enable --resource-types LAMBDA

### List findings after a few minutes:

aws inspector2 list-findings \
  --filter-criteria '{"resourceTypes":[{"comparison":"EQUALS","value":"AWS_LAMBDA_FUNCTION"}]}' \
  --query 'findings[].{Severity:severity, Title:title, Package:packageVulnerabilityDetails.vulnerablePackages[0].name, Version:packageVulnerabilityDetails.vulnerablePackages[0].version}' \
  --output table

### Optional SBOM (AWS-native): Install Amazon Inspector SBOM Generator (sbomgen) locally or run it in CodeBuild to produce a CycloneDX SBOM for the layer folder, then store in S3:

sbomgen -d <path-to-layer-folder> -o sbom.json -f cyclonedx
aws s3 cp sbom.json s3://<YOUR_BUCKET>/sbom/sbom.json

## D. Remediate

### 1. Pin & upgrade to patched versions (edit requirements.txt, rebuild layer, re-deploy).

### 2. Keep Amazon Inspector enabled; create EventBridge rules on high/critical findings → SNS (email/Slack via Chatbot).

### 3. Rotate/update functions regularly; use separate layers per service to minimize blast radius of a vulnerable library.

### Cleanup:

aws cloudformation delete-stack --stack-name cfn-vuln-deps

   <img width="1816" height="671" alt="image" src="https://github.com/user-attachments/assets/40569906-b466-4c37-b8f3-55b695afbee3" />

